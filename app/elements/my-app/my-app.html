<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../country-service/country-service.html">

<dom-module id="my-app">
  <link rel="stylesheet" href="my-app.css">
  <template is="dom-bind">

    <country-service id="service" data="{{countryData}}"></country-service>

    <h3>Multi-select</h3>

    <input type="text" on-input="searchVal" id="search">
    <!--<array-selector id="selector" items="{{countryData}}" selected="{{selected}}" multi toggle></array-selector>-->
    <div id="Loading" hidden="{{!enabled}}">Loading...</div>
    <div id="collapse">
      <iron-collapse fixedSize="true" id="collapse1">
        <div id="scroll" on-scroll="scrollData">
          <div class="canvas" id="canvas">
            <template is="dom-repeat" items="{{cData}}" id="dataRepeater">
              <div class="renderer" on-click="selectOption" style$="{{computeTop(index)}}">{{item.name}}</div>
            </template>
          </div>
        </div>
      </iron-collapse>
    </div>

    <div> Selected Country: </div>
    <template is="dom-repeat" items="{{selected}}">
      <div>{{item.name}}</div>
    </template>

  </template>
</dom-module>

<script>
  var typingTimer;                //timer identifier
  var doneTypingInterval = 500;  //time in ms, 5 second for example

  Polymer({
    is: "my-app",

    properties: {
      enabled: {
        type: Boolean,
        value: false
      },
      cData: {
        type: Object,
        value: [],
        notify: true
      },
      rowHeight: {
        type: Number,
        value: 30
      }
      ,
      height: {
        type: Number,
        value: 200
      },
      scrollTop: {
        type: Number,
        value: 0,
        notify: true
      },
      cellsPerPage: {
        type: Number,
        value: 0
      },
      numberOfCells: {
        type: Number,
        value: 0
      },
      firstCell: {
        type: Number,
        value: 0
      },
      selected: {
        type: Array,
        value: [],
        notify: true
      }
    },

    searchVal: function () {
        var myApp = this;
        myApp.enabled = true;
        myApp.scrollTop = 0;
        clearTimeout(typingTimer);
        typingTimer = setInterval(function () {
          clearTimeout(typingTimer);
          myApp.enabled = false;
          myApp.cellsPerPage = Math.round(myApp.height / myApp.rowHeight);
          myApp.numberOfCells = 3 * myApp.cellsPerPage;

          myApp.updateDisplayList();

        }, doneTypingInterval);
    },
    scrollData: function () {
      var searchData = this.$.search.value;
      this.scrollTop = this.$.scroll.scrollTop;
      this.updateDisplayList();

    },
    updateDisplayList: function () {
      var thisData = this;
      var searchData = this.$.search.value;
      if(searchData.length < 2)
        searchData = '';
      var firstCell = Math.max(Math.floor(this.scrollTop / this.rowHeight) - this.cellsPerPage, 0);
      var cellsToCreate = Math.min(firstCell + this.numberOfCells, this.numberOfCells);
      var searchResult = this.$.service.searchData(searchData, firstCell, firstCell + cellsToCreate);
      this.cData = searchResult.data;
      var ironSelector = Polymer.dom(this.root).querySelector('div.canvas');
      ironSelector.setAttribute('style', 'height: ' + searchResult.totalCount * this.rowHeight + 'px;');
      var childNodes = Polymer.dom(this.root).querySelectorAll('div.renderer');
      for (var i = 0; i < childNodes.length; i++) {
        childNodes[i].setAttribute('style', 'top: ' + ((firstCell + i) * this.rowHeight) + 'px;');
      }
    },
    computeTop: function (index) {
      return 'top: ' + (index * this.rowHeight) + 'px';
    },
    selectOption: function (e) {
      e.target.classList.toggle('selected');
      var item = this.$.dataRepeater.itemForElement(e.target);
      if(_.findIndex(this.selected, item) === -1){
        this.selected.push(item);
      }
      else {
        _.remove(this.selected, item);
      }
    }
  });
</script>
